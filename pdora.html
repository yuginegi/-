<html>
<head>
<meta http-equiv="content-type" content="text/html" charset="UTF-8">
</head>
<body>
<canvas id="screen"></canvas>
<script>
var gXXX = 400;
var gYYY = 400;

var dlist = "";
window.onload = function(){
  // HTML上のCanvasに対して絵を描く準備。CTXを得る
  let screenCanvas = document.getElementById('screen');
  screenCanvas.width  = gXXX;
  screenCanvas.height = gYYY;
  let ctx = screenCanvas.getContext('2d');

  window.addEventListener("mousedown", pos, false);
  window.addEventListener("mousemove", pos, false);
  window.addEventListener("mouseup",  pos, false);

  dlist = new droplist();

  // 無限ループする
  infiniteloop(ctx);
}
function infiniteloop(ctx){
  // 30FPSで無限ループするための「setInterval」 
  setInterval(mainloop, 1000/30, ctx);
}
var tt = 0;
function mainloop(ctx){

  let [x,y] = gpos;
  if(x<0 || y<0 || 300<=x || 250<=y){
    dlist.release();
  }else{
    dlist.grasp(x,y);
  }

  draw(ctx);
}
function draw(ctx){
  dlist.draw(ctx);
}

var gpos=[-1,-1];
function pos(e){
  let [x,y] = [e.clientX,e.clientY];
  //console.log("pos:"+e.type);
  if(e.type == "mouseup"){
    gpos=[-1,-1];
  }else if(e.type == "mousedown"){
    if(gpos[0]==-1 && gpos[1]==-1){
      gpos=[x,y];
    }
  }else{
    if(gpos[0]!=-1 && gpos[1]!=-1){
      gpos=[x,y];
    }
  }
}

class droplist{
  constructor(){
    this.target = -1;
    this.init();
  }
  init(){
    this.dlist = [];
    for(let i=0;i<30;i++){
      this.dlist[i] = new drop();
      let x = (i%6);
      let y = Math.floor(i/6);
      let c = i;
      this.dlist[i].setPos(x,y,c);
    }
  }
  draw(ctx){
    for(let i=0;i<30;i++){
      this.dlist[i].draw(ctx);
    }
  }
  release(){
    if(this.target==-1){return;}
    let i = this.target;
    this.dlist[i].sp = 0;
    this.target = -1;
  }
  grasp(x,y){
    if(x<0||y<0||x>=300||y>=250){return;}
    if(this.target==-1){
      let i = this.search(x,y);
      //console.log("search:"+[x,y,i]);
      this.target = i;
      this.dlist[i].sp = 1;
      return;
    }
    let i = this.target;
    let s = this.search(x,y);
    if(i!=s){
      let a = this.dlist[i].getP();
      let b = this.dlist[s].getP();
      this.dlist[s].setP(a);
      this.dlist[i].setP(b);
    }
  }
  search(x,y){
    for(let i=0;i<30;i++){
      let r = this.dlist[i].isin(x,y);
      if(r){return i;}
    }
    return -1;
  }
}

class drop{
  constructor(){}
  setPos(i,j,v){
    this.ix = i;
    this.iy = j;
    this.v = v;
    this.ll = 50;
    this.sp = 0;
  }
  getP(){
    return [this.ix,this.iy];
  }
  setP(arg){
    [this.ix,this.iy] = arg;
  }
  draw(ctx){
    let [x,y,ll] = [this.ix, this.iy, this.ll];
    let cl = ["#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF"];
    if(this.sp){
    let mg = 2;
    ctx.fillStyle = "#000000";
    ctx.fillRect(x*ll,y*ll,ll,ll);
    ctx.fillStyle = cl[this.v%cl.length];
    ctx.fillRect(x*ll+mg,y*ll+mg,ll-2*mg,ll-2*mg);      
    }else{
    ctx.fillStyle = cl[this.v%cl.length];
    ctx.fillRect(x*ll,y*ll,ll,ll);
    }
  }
  isin(x0,y0){
    let [x,y,ll] = [this.ix, this.iy, this.ll];
    //console.log("isin:"+[x*ll , x0, x*(ll+1) , y*ll , y0 , y*(ll+1)])
    if(x*ll <= x0 && x0 < (x+1)*ll && y*ll <= y0 && y0 < (y+1)*ll ){
      return 1;
    }
    return 0;
  }
}

</script>
</body>
</html>
