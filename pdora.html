<html>
<head>
<meta http-equiv="content-type" content="text/html" charset="UTF-8">
</head>
<body>
<canvas id="screen"></canvas>
<script>
var gXXX = 400;
var gYYY = 400;

window.onload = function(){
  addMouseEventListener();
  // HTML上のCanvasに対して絵を描く準備。CTXを得る
  let screenCanvas = document.getElementById('screen');
  screenCanvas.width  = gXXX;
  screenCanvas.height = gYYY;
  let ctx = screenCanvas.getContext('2d');
  let dlist = new droplist();
  // 30FPSで無限ループするための「setInterval」 
  setInterval(mainloop, 1000/30, ctx, dlist);
}

var gstatus = 0;
var movefunc = [state0,state1,state2,state3];
function mainloop(ctx,dlist){
  // Move action
  movefunc[gstatus](dlist);
  // Background
  ctx.clearRect(0, 0, gXXX, gYYY);
  ctx.fillStyle="#000000";
  ctx.fillRect(0, 0, 300, 250);
  // Draw
  dlist.draw(ctx);
}

// move wait
function state0(dlist){
  let [x,y] = mousepos;
  if(x<0 || y<0 || 300<=x || 250<=y){
  }else{
    dlist.grasp(x,y);
    console.log("State: 0 -> 1");
    gstatus++;
  }
}
// drop move
function state1(dlist){
  let [x,y] = mousepos;
  if(x<0 || y<0 || 300<=x || 250<=y){
    dlist.release();
    console.log("State: 1 -> 2");
    gstatus++;
  }else{
    dlist.grasp(x,y);
  }
}
// drop erace => Now, change color=white
function state2(dlist){
  dlist.eracesearch();
  console.log("State: 2 -> 3");
  gstatus++;
}
// zzz
function state3(dlist){
}

var mousepos=[-1,-1];
function mouseeventfunc(e){
  let [x,y] = [e.clientX,e.clientY];
  //DBG//console.log("pos:"+e.type);
  if(e.type == "mouseup"){
    mousepos=[-1,-1];
  }else if(e.type == "mousedown" && mousepos[0]==-1){
    mousepos=[x,y];
  }else if(e.type == "mousemove" && mousepos[0]!=-1){
    mousepos=[x,y];
  }
}
function addMouseEventListener(){
  window.addEventListener("mousedown", mouseeventfunc, false);
  window.addEventListener("mousemove", mouseeventfunc, false);
  window.addEventListener("mouseup",  mouseeventfunc, false);
}

class droplist{
  constructor(){
    this.target = -1; // -1 is released.
    this.init();
  }
  init(){
    this.dlist = [];
    for(let i=0;i<30;i++){
      let x = (i%6);
      let y = Math.floor(i/6);
      let cl = ["#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF"];
      let c = cl[i%5];
      this.dlist[i] = new drop(i,x,y,c);
    }
  }
  draw(ctx){
    for(let i=0;i<30;i++){
      this.dlist[i].draw(ctx);
    }
    if(this.target!=-1){
      this.dlist[this.target].drawsp(ctx);
    }
  }
  release(){
    // mouseup
    if(this.target==-1){return;}
    this.dlist[this.target].sp = 0;
    this.target = -1;
  }
  grasp(x,y){
    // mousedown
    if(this.target==-1){
      let i = this.search(x,y);
      if(i<0){
        console.log("Unexpected flow.")
        return;
      }
      this.dlist[i].sp = 1;
      this.target = i;
      return;
    }
    // mousemove
    let i = this.target;
    let s = this.search(x,y);
    if(i!=s){
      let tmp = this.dlist[i].getP();
      this.dlist[i].setP(this.dlist[s].getP());
      this.dlist[s].setP(tmp);
    }
  }
  search(x,y){
    for(let i=0;i<30;i++){
      let r = this.dlist[i].isin(x,y);
      if(r){return i;}
    }
    return -1;
  }
//=== From here, it should reconsider better code ===
  eracesearch(){
    // create 5x6 array
    var arr = new Array(5);
    for(var b = 0; b < 5; b++) {
      arr[b] = new Array(6);
      for(var a = 0; a < 6; a++) {
        arr[b][a] = 0;
      }
    }
    // set arr
    for(let i=0;i<30;i++){
      let [ix,iy] = this.dlist[i].getP();
      arr[iy][ix] = i;
    }
    // arr search hori
    for(var b = 0; b < 5; b++) {
    for(var a = 0; a < 6; a++) {
      {
        let n = this.www(arr,b,a+1,arr[b][a],1);
        if(n>=3){
          for(let i=0;i<n;i++){
            //console.log("www:"+[a+i,b]);
            let ii = arr[b][a+i];
            this.dlist[ii].ee = 1;
          }
        }
      }
      {
        let n = this.hhh(arr,b+1,a,arr[b][a],1);
        if(n>=3){
          for(let i=0;i<n;i++){
            //console.log("hhh:"+[a,b+i]);
            let ii = arr[b+i][a];
            this.dlist[ii].ee = 1;
          }
        }
      }
    }}
  }
  www(arr,b,a,c,n){
    if(a >= 6){return n;}
    if(b >= 5){return n;}
    let ii = arr[b][a];
    if(this.dlist[c].cl == this.dlist[ii].cl){
      return this.www(arr,b,a+1,c,n+1);
    }
    return n;
  }
  hhh(arr,b,a,c,n){
    if(a >= 6){return n;}
    if(b >= 5){return n;}
    let ii = arr[b][a];
    if(this.dlist[c].cl == this.dlist[ii].cl){
      return this.hhh(arr,b+1,a,c,n+1);
    }
    return n;
  }
//=== To here, it should reconsider better code ===
}

class drop{
  constructor(id,x,y,cl){
    this.id = id; // id 
    this.ix = x;  // index horizontal
    this.iy = y;  // index vertical
    this.cl = cl; // color
    this.ll = 50;
    this.sp = 0;
  }
  getP(){
    return [this.ix,this.iy];
  }
  setP(arg){
    [this.ix,this.iy] = arg;
  }
  draw(ctx){
    let [x,y,ll,cl] = [this.ix, this.iy, this.ll, this.cl];
    if(this.ee){
      drawdrop(ctx,"#FFFFFF",x*ll,y*ll,ll,ll);
      let mg = 10;
      drawdrop(ctx,cl,x*ll+mg,y*ll+mg,ll-(2*mg),ll-(2*mg));
      return;
    }
    if(this.sp){
      //ctx.fillStyle = "#000000";
      //ctx.fillRect(x*ll,y*ll,ll,ll);
      drawdrop(ctx,"#000000",x*ll,y*ll,ll,ll);
    }else{
      //ctx.fillStyle = cl;
      //ctx.fillRect(x*ll,y*ll,ll,ll);
      drawdrop(ctx,cl,x*ll,y*ll,ll,ll);
    }
  }
  drawsp(ctx){
    let [ll,cl] = [this.ll, this.cl];
    let [mx,my] = mousepos;
    //ctx.fillStyle = cl;
    //ctx.fillRect(mx-ll/2,my-ll/2,ll,ll);
    drawdrop(ctx,cl,mx-ll/2,my-ll/2,ll,ll);
  }
  isin(x0,y0){
    let [x,y,ll] = [this.ix, this.iy, this.ll];
    if(x*ll <= x0 && x0 < (x+1)*ll && y*ll <= y0 && y0 < (y+1)*ll ){
      return 1;
    }
    return 0;
  }
}

function drawdrop(ctx,cl,x,y,w,h){
  ctx.beginPath();
  ctx.fillStyle = cl;
  //ctx.fillRect(x,y,w,h);
  let r = (w+h-10)/2
  ctx.arc( x+(w/2), y+(h/2), r/2, 0, Math.PI * 2, true);
  ctx.fill();
}

</script>
</body>
</html>
