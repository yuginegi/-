<HTML>
<HEAD>
<script>
var timer;
var can;
var ctx; // 描画のためのグローバル変数

var gIntval = 50; // 50ミリ秒で描画更新する

var gtime = 0; // 時間情報

var gMathLen = 40; // マスの大きさ

//縦12マス×横6マス
var array;
function arrayInit(){
  array = new Array(12);
  arrayReset();
}
function arrayReset(){
  for(let i=0;i<12;i++){
    array[i] = [0,0,0,0,0,0];
  }
}

var colorptn = ["","#FF0000","#00FF00"];
function drawMath(v,x,y){
  if(v <= 0 || colorptn.length <= v){return;}
  ctx.fillStyle = colorptn[v];
  ctx.fillRect(x,y,gMathLen,gMathLen);
}

function drawBack(x,y,w,h){
  ctx.fillStyle = "#FFFFFF";
  ctx.fillRect(x,y,w,h);
}


function runProgram(){
console.log("runProgram");
  can = document.getElementById("drawcanvas");
  ctx = can.getContext("2d");
  // キーボード受付
  window.addEventListener("keydown", kdown, { passive: false });
  window.addEventListener("keyup", kup, { passive: false });
  // 初期化
  arrayInit();
  // ループ
  doLoop();
}

function doLoop(){
  timer = setInterval(mainLoop, gIntval);
}

function mainLoop(){
  // 状態遷移
  stateControl();
  // マスをコントロールがんばってする（外部入力考慮したり）
  moveControl();
  // 描画処理はこっちでする
  drawMain();
}

var gsts = 0;
function stateControl(){
  if(gsts == 0){ // ぷよきめ
    gsts = 1;
    ggg = [[2,0,1],[3,0,2]]
  }
}

function moveControl_old(){
  let tt = gtime%500; //500で一周
  if(tt == 0){
    arrayReset();
  }
  if(tt%50 == 0){
    let v = 1+(tt/50)%10;
    array[v][1] = (v%2)? 1:2;
  }
  //時間
  gtime++;
}

var ggg = [[0,0,0],[0,0,0]];
function moveControl(){
  let axe = kfunc(1);
  console.log("a:"+axe);
  let backup = deepCopyA(ggg);
  let flag = moveX(axe);
  if(flag==1){ggg = deepCopyA(backup);}
}

function deepCopyA(aaa){
  let out = [[0,0,0],[0,0,0]];
  for(let i=0;i<2;i++){
  for(let j=0;j<3;j++){
    out[i][j] = aaa[i][j];
  }}
  return out;
}

function moveX(axe){
  for(let i=0;i<2;i++){
    ggg[i][0] += axe[0];
    if(ggg[i][0] < 0 || 6 <= ggg[i][0]){return 1;}
    ggg[i][1] += axe[1];
    if(ggg[i][1] < 0 || 12 <= ggg[i][1]){return 1;}
  }
}

function drawMain(){
  let [sx,sy] = [110,10]; // 書き出し位置

  // 白背景
  drawBack(sx,sy, gMathLen*6,gMathLen*12);

  // オブジェクトの色
  for(let i=0;i<12;i++){
  for(let j=0;j<6;j++){
    let v = array[i][j];
    let x = sx+gMathLen*j;
    let y = sy+gMathLen*i;
    drawMath(v,x,y);
  }}
  // ドロップ描画
  for(let i=0;i<2;i++){
    let [a,b,v] = ggg[i];
    let x = sx+gMathLen*a;
    let y = sy+gMathLen*b;
    drawMath(v,x,y);
  }
}

//=== キーボード対応 ここから ======= 
var kaxes = [0,0];
var kpush = 0; // 0 を無効とする。1を基準に押された数字
function kstate(oo,aa){
  if(aa==1){
    kaxes[0] = -1*oo;
  }else if(aa==2){
    kaxes[0] = +1*oo;
  }else if(aa==3){
    kaxes[1] = -1*oo;
  }else if(aa==0){
    kaxes[1] = +1*oo;
  }else if(aa==10){
    kpush = +1*oo;
  }else if(aa==11){
    kpush = +2*oo;
  }
}
function kfunc(aaa){
  if(aaa==1){return kaxes;}
}
function kcommon(key,v){
  switch(key) {
    case "z":
      kstate(v,10);
      break;
    case "x":
      kstate(v,11); // BOM
      break;
    case "ArrowDown":
      kstate(v,0);
      break;
    case "ArrowUp":
      kstate(v,3);
      break;
    case "ArrowLeft":
      kstate(v,1);
      break;
    case "ArrowRight":
      kstate(v,2);
      break;
    }
}
function kup(event){
  kcommon(event.key,0);
}
function kdown(event){
  kcommon(event.key,1);
  switch(event.key) {
  case "Enter":
    if(startPintvl <= 0){
      startPushed = 1;
      startPintvl = 60;
    }
    break
  }
}
//=== キーボード対応 ここまで ======= 
</script>
</HEAD>
<BODY bgcolor="#000000" onload="runProgram()">
<canvas id="drawcanvas" width=500 height=500 style="background-color: gray"></canvas>
</BODY>
</HTML>
